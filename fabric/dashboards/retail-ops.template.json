{
  "$schema": "https://fabric.microsoft.com/schemas/dashboard/2024-01-01-preview",
  "name": "Retail Ops - Real-Time",
  "description": "Minimal dashboard wired to KQL views/querysets",
  "tiles": [
    {
      "title": "Sales/min by Store (1h)",
      "type": "kql",
      "dataset": {
        "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>"
      },
      "query": "mv_store_sales_minute | where ts > ago(60m) | summarize total_sales=sum(total_sales) by store_id | top 10 by total_sales desc"
    },
    {
      "title": "Online Orders (15m)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "let window=15m; online_order_created | where ingest_timestamp > ago(window) | summarize orders=count(), subtotal=sum(subtotal), tax=sum(tax), total=sum(total) | extend aov=toreal(total)/toreal(orders) | project orders, aov, total"
    },
    {
      "title": "Fulfillment Pipeline (24h)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "let window=24h; let c=online_order_created | where ingest_timestamp > ago(window) | summarize created=count(); let p=online_order_picked | where ingest_timestamp > ago(window) | summarize picked=count(); let s=online_order_shipped | where ingest_timestamp > ago(window) | summarize shipped=count(); c | join kind=fullouter p on 1==1 | join kind=fullouter s on 1==1 | extend created=coalesce(created,0), picked=coalesce(picked,0), shipped=coalesce(shipped,0) | project created, picked, shipped"
    },
    {
      "title": "BLE Presence (30m)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "let window=30m; ble_ping_detected | where ingest_timestamp > ago(window) | summarize devices=dcount(customer_ble_id) by store_id | top 10 by devices desc"
    },
    {
      "title": "Marketing Cost (24h)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "let window=24h; ad_impression | where ingest_timestamp > ago(window) | summarize impressions=count(), cost=sum(cost) by campaign_id | top 10 by cost desc"
    },
    {
      "title": "Tender Mix (15m)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "payment_processed | where ingest_timestamp > ago(15m) | summarize amount=sum(amount) by payment_method | order by amount desc"
    },
    {
      "title": "Top Products (15m)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "let window=15m; receipt_line_added | where ingest_timestamp > ago(window) | summarize revenue=sum(extended_price) by product_id | top 10 by revenue desc"
    },
    {
      "title": "Open Stockouts (24h)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "stockout_detected | where ingest_timestamp > ago(24h) | summarize count() by store_id | top 10 by count_ desc"
    },
    {
      "title": "Zone Dwell Heatmap (30m)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "mv_zone_dwell_minute | where ts > ago(30m) | summarize customers=sum(customers) by zone | top 10 by customers desc"
    },
    {
      "title": "Truck Dwell by Site (24h)",
      "type": "kql",
      "dataset": { "kqlDatabaseResourceId": "<fabric-kql-database-resource-id>" },
      "query": "mv_truck_sla | where arrival_time > ago(24h) | extend site=iif(isnotnull(store_id), strcat('Store-', tostring(store_id)), strcat('DC-', tostring(dc_id))) | summarize avg_dwell_min=avg(dwell_seconds)/60.0 by site | top 10 by avg_dwell_min desc"
    }
  ]
}
